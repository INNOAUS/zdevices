Taken from http://github.com/sustrik/zeromq2/blob/master/zmqd/